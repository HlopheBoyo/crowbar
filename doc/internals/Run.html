<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Run
  
    &mdash; Documentation by YARD 0.8.7.6
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!Run.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (R)</a> &raquo;
    
    
    <span class="title">Run</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Run
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">ActiveRecord::Base</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ActiveRecord::Base</li>
          
            <li class="next">Run</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">rails/app/models/run.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Copyright 2013, Dell</p>

<p>Licensed under the Apache License, Version 2.0 (the “License”); you may not
use this file except in compliance with the License. You may obtain a copy
of the License at</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_http'>http</span><span class='symbol'>:/</span><span class='op'>/</span><span class='id identifier rubyid_www'>www</span><span class='period'>.</span><span class='id identifier rubyid_apache'>apache</span><span class='period'>.</span><span class='id identifier rubyid_org'>org</span><span class='op'>/</span><span class='id identifier rubyid_licenses'>licenses</span><span class='op'>/</span><span class='const'>LICENSE</span><span class='op'>-</span><span class='float'>2.0</span></code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations
under the License.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#empty%3F-class_method" title="empty? (class method)">+ (Boolean) <strong>empty?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#enqueue-class_method" title="enqueue (class method)">+ (Object) <strong>enqueue</strong>(nr) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Queue up a job to run.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run%21-class_method" title="run! (class method)">+ (Object) <strong>run!</strong>(maxjobs = 10) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Run up to maxjobs jobs, enqueuing runnable noderoles in TODO as it goes.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sort_id-instance_method" title="#sort_id (instance method)">- (Object) <strong>sort_id</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  

  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="empty?-class_method">
  
    + (<tt>Boolean</tt>) <strong>empty?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33
34
35</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rails/app/models/run.rb', line 31</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_locked_transaction'>locked_transaction</span> <span class='kw'>do</span>
    <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>==</span> <span class='int'>0</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="enqueue-class_method">
  
    + (<tt>Object</tt>) <strong>enqueue</strong>(nr) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Queue up a job to run. Run.enqueue should only be called when you want to
enqueue a noderole that is in a state other than TODO, as those will be
picked up by Run.run! The main callers of this should mostly be events
called from role triggers.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rails/app/models/run.rb', line 41</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_enqueue'>enqueue</span><span class='lparen'>(</span><span class='id identifier rubyid_nr'>nr</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cannot enqueue a nil node_role!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_locked_transaction'>locked_transaction</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_queued_run'>queued_run</span> <span class='op'>=</span> <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>node_role_id:</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>running:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_queued_run'>queued_run</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run: Updating enqueued </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_queued_run'>queued_run</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'> with new run data for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_queued_run'>queued_run</span><span class='period'>.</span><span class='id identifier rubyid_update!'>update!</span><span class='lparen'>(</span><span class='label'>run_data:</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_jig'>jig</span><span class='period'>.</span><span class='id identifier rubyid_stage_run'>stage_run</span><span class='lparen'>(</span><span class='id identifier rubyid_nr'>nr</span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='rparen'>)</span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_runnable?'>runnable?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_active?'>active?</span> <span class='op'>||</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_todo?'>todo?</span> <span class='op'>||</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_transition?'>transition?</span><span class='rparen'>)</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run: Not enqueing </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run: Enqueing Run for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_create!'>create!</span><span class='lparen'>(</span><span class='label'>node_id:</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_node_id'>node_id</span><span class='comma'>,</span>
                <span class='label'>node_role_id:</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span>
                <span class='label'>run_data:</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span>  <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_jig'>jig</span><span class='period'>.</span><span class='id identifier rubyid_stage_run'>stage_run</span><span class='lparen'>(</span><span class='id identifier rubyid_nr'>nr</span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_run!'>run!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run!-class_method">
  
    + (<tt>Object</tt>) <strong>run!</strong>(maxjobs = 10) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Run up to maxjobs jobs, enqueuing runnable noderoles in TODO as it goes.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rails/app/models/run.rb', line 63</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_run!'>run!</span><span class='lparen'>(</span><span class='id identifier rubyid_maxjobs'>maxjobs</span><span class='op'>=</span><span class='int'>10</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_jobs'>jobs</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_locked_transaction'>locked_transaction</span> <span class='kw'>do</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run: Queue: (start) </span><span class='embexpr_beg'>#{</span><span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Job: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'>: running:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_running'>running</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: state </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_running'>running</span> <span class='op'>=</span> <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_running'>running</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span>
    <span class='comment'># Look for enqueued runs and schedule at most one per node to go.
</span>    <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_runnable'>runnable</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span>
      <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='id identifier rubyid_running'>running</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_maxjobs'>maxjobs</span>
      <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_jobs'>jobs</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_id'>node_id</span><span class='rbracket'>]</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run: Setting enqueued run </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'> for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> to running</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_running'>running</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
      <span class='id identifier rubyid_jobs'>jobs</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_id'>node_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_j'>j</span>
    <span class='kw'>end</span>

    <span class='comment'># Find any runnable noderoles and see if they can be enqueued.
</span>    <span class='comment'># The logic here will only enqueue a noderole of the node does not
</span>    <span class='comment'># already have a noderole enqueued.
</span>    <span class='const'>NodeRole</span><span class='period'>.</span><span class='id identifier rubyid_runnable'>runnable</span><span class='period'>.</span><span class='id identifier rubyid_order'>order</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cohort ASC, id ASC</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_nr'>nr</span><span class='op'>|</span>
      <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='id identifier rubyid_running'>running</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_maxjobs'>maxjobs</span>
      <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_jobs'>jobs</span><span class='lbracket'>[</span><span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_node_id'>node_id</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_exists?'>exists?</span><span class='lparen'>(</span><span class='label'>node_id:</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_node_id'>node_id</span><span class='rparen'>)</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run: Creating new Run for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_jobs'>jobs</span><span class='lbracket'>[</span><span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_node_id'>node_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_create!'>create!</span><span class='lparen'>(</span><span class='label'>node_id:</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_node_id'>node_id</span><span class='comma'>,</span>
                                     <span class='label'>node_role_id:</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span>
                                     <span class='label'>running:</span> <span class='kw'>true</span><span class='comma'>,</span>
                                     <span class='comment'># Take a snapshot of the data we want to hand to the jig&#39;s run method.
</span>                                     <span class='comment'># We do this so that the jig gets fed data that is consistent for this point
</span>                                     <span class='comment'># in time, as opposed to picking up whatever is lying around when delayed_jobs
</span>                                     <span class='comment'># gets around to actually doing its thing, which may not be what we expect.
</span>
                                     <span class='label'>run_data:</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>data</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_nr'>nr</span><span class='period'>.</span><span class='id identifier rubyid_jig'>jig</span><span class='period'>.</span><span class='id identifier rubyid_stage_run'>stage_run</span><span class='lparen'>(</span><span class='id identifier rubyid_nr'>nr</span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>0</span>
  <span class='comment'># Now that we have things that are runnable, loop through them to see
</span>  <span class='comment'># what we can actually run.
</span>  <span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run: Sending job </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> to delayed_jobs</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='comment'># dev mode not starting queued jobs, we need to skip queuing for now
</span>    <span class='kw'>if</span> <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span><span class='period'>.</span><span class='id identifier rubyid_development?'>development?</span>
      <span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_jig'>jig</span><span class='period'>.</span><span class='id identifier rubyid_run_job'>run_job</span><span class='lparen'>(</span><span class='id identifier rubyid_j'>j</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_jig'>jig</span><span class='period'>.</span><span class='id identifier rubyid_delay'>delay</span><span class='lparen'>(</span><span class='symbol'>:queue</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>NodeRoleRunner</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_run_job'>run_job</span><span class='lparen'>(</span><span class='id identifier rubyid_j'>j</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> handled this pass, </span><span class='embexpr_beg'>#{</span><span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_running'>running</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='embexpr_end'>}</span><span class='tstring_content'> in delayed_jobs</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='comment'># log queue state
</span>    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run: Queue: (end) </span><span class='embexpr_beg'>#{</span><span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Job: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'>: running:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_running'>running</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: state </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>rescue</span>
    <span class='comment'># catch node_role is nil (exposed in simulator runs)
</span>    <span class='const'>Run</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span> <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>you cannot run job </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'> with missing node </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_id'>node_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> and node_role </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role_id'>node_role_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> information.  This is likely a garbage collection issue!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_j'>j</span><span class='period'>.</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="sort_id-instance_method">
  
    - (<tt>Object</tt>) <strong>sort_id</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


27
28
29</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'rails/app/models/run.rb', line 27</span>

<span class='kw'>def</span> <span class='id identifier rubyid_sort_id'>sort_id</span>
  <span class='lbracket'>[</span><span class='id identifier rubyid_node_role'>node_role</span><span class='period'>.</span><span class='id identifier rubyid_cohort'>cohort</span><span class='comma'>,</span> <span class='id identifier rubyid_node_role_id'>node_role_id</span><span class='comma'>,</span> <span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Mar 13 01:25:13 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.1.5).
</div>

  </body>
</html>